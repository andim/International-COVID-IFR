# plot log titer by status
tdis <- ggplot(data)+ geom_histogram(aes(x=log(IgG_DEN), fill=factor(dnv)), bins=50, alpha=0.7)+
scale_fill_manual(values=c('navajowhite', 'tomato', 'grey60'), labels=c('Neg', 'Pos', 'Equivocal'), name='')+
theme_minimal()+ xlab('log IgG dengue titer')
# group ages
data$agrp <- findInterval(data$age, c(seq(0,60,5), 100))
ages <- c("1-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39",
"40-44", "45-49", "50-54", "55-59", "60+")
for(i in 1:nrow(data)){ data$agegrp[i] <- ages[data$agrp[i]]}
data$agegrp <- factor(data$agegrp, levels=c("1-4","5-9","10-14","15-19","20-24","25-29",
"30-34","35-39","40-44","45-49","50-54","55-59","60+"))
# proportion positive by age
new <- data.frame(age=sort(unique(data$agegrp)), TotData=NA, PosData=NA, serop=NA, lower_ci=NA, upper_ci=NA, fa=NA)
for(i in 1:nrow(new)){
x <- data[(data$agegrp==new$age[i] & data$dnv<5), ]
ci <- binom.exact(sum(x$dnv), nrow(x))
new[i,2:6] <- c(nrow(x), sum(x$dnv), sum(x$dnv)/nrow(x), ci[1,4], ci[1,5])
}
new$fa <- new$TotData/sum(new$TotData)
new$AgeMid <- c(2.5,7,12,17,22,27,32,37,42,47,52,57,65)
new$P_inf <- 1-exp(-0.0078*new$AgeMid) # estimates from beta-binomial model
new$P_infL <- 1-exp(-0.0061*new$AgeMid)
new$P_infU <- 1-exp(-0.0099*new$AgeMid)
foi <- ggplot(new, aes(AgeMid, serop))+ geom_point()+ geom_linerange(aes(x=AgeMid, ymin=lower_ci, ymax=upper_ci))+
theme_minimal()+ ylab('Proportion positive')+ theme(axis.text.x=element_text(angle=60, hjust=1))+
geom_line(aes(x=AgeMid, y=P_inf), col='tomato')+ scale_x_continuous(breaks=new$AgeMid, labels=ages)+
geom_ribbon(aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='tomato', alpha=0.5)+ xlab('Age')
plot_grid(tdis, foi, labels=c('(A)', '(B)'))
# overall seroprevalence
#binom.exact(sum(data$dnv[data$dnv<98]), nrow(data))
library(rstan)
setwd('C:/Users/Megan/Desktop/Bangladesh/FinalFits/')
dnv2 <- readRDS('Chapai_IgGDEN_constant.RDS')
chains <- extract(dnv2$fit)
# extract param values
lam_a <- mean(chains$lambda_a)
mu0_a <- mean(chains$sigma_0)
mu_a <- mean(chains$sigma_1)
sd0_a <- mean(chains$epsilon0)
sd_a <- mean(chains$epsilon)
data$Y <- log(data$IgG_DEN)
df <- data
for(i in 1:nrow(data)){
ta = data$Y[i]
age = data$age[i]
pa =  1-exp(-lam_a*age)
df$likpos[i]=dgamma(ta, shape=((mu0_a+mu_a)^2/sd_a^2), scale=(sd_a^2/(mu0_a+mu_a)))*pa
df$likneg[i]=dnorm(ta, mu0_a, sd0_a)*(1-pa)
}
df <- df[!(is.na(df$Y)), ]
# assign most likely status
df$pos <- df$likpos/(df$likpos+df$likneg)
df$neg <- df$likneg/(df$likpos+df$likneg)
df$status <- 0
df$status[df$pos>0.5] <- 1
# plot
tdis2 <- ggplot(df, aes(Y))+ geom_histogram(bins=50, aes(fill=factor(status)), alpha=0.7)+
theme_minimal()+ xlab('log IgG dengue titer')+
scale_fill_manual(values=c('navajowhite', 'tomato'), labels=c('Neg', 'Pos'), name='')#+
#geom_vline(xintercept=c(mu0_a, mu0_a+mu_a))
new2 <- new
for(i in 1:nrow(new)){
x <- df[(df$agegrp==new$age[i]), ]
ci <- binom.exact(sum(x$status), nrow(x))
new2[i,2:6] <- c(nrow(x), sum(x$status), sum(x$status)/nrow(x), ci[1,4], ci[1,5])
}
new2$P_inf <- 1-exp(-lam_a*new2$AgeMid)
new2$P_infL <- 1-exp(-quantile(chains$lambda_a, 0.025)*new2$AgeMid)
new2$P_infU <- 1-exp(-quantile(chains$lambda_a, 0.975)*new2$AgeMid)
foi2 <- ggplot(new2)+ geom_point(aes(AgeMid+0.5, serop), col='tomato3')+
geom_linerange(aes(x=AgeMid+0.5, ymin=lower_ci, ymax=upper_ci), col='tomato3')+
theme_minimal()+ ylab('Proportion positive')+ theme(axis.text.x=element_text(angle=60, hjust=1))+
geom_line(aes(x=AgeMid, y=P_inf), col='tomato')+ scale_x_continuous(breaks=new$AgeMid, labels=ages)+
geom_ribbon(aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='tomato', alpha=0.5)+ xlab('Age')+
geom_point(data=new, aes(AgeMid-0.5, serop))+
geom_linerange(data=new, aes(x=AgeMid-0.5, ymin=lower_ci, ymax=upper_ci))+
geom_line(data=new, aes(x=AgeMid, y=P_inf), col='tomato')+ scale_x_continuous(breaks=new$AgeMid,
labels=ages)+
geom_ribbon(data=new, aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='tomato', alpha=0.5)+ xlab('Age')+
library(ggplot2)
foi2 <- ggplot(new2)+ geom_point(aes(AgeMid+0.5, serop), col='tomato3')+
geom_linerange(aes(x=AgeMid+0.5, ymin=lower_ci, ymax=upper_ci), col='tomato3')+
theme_minimal()+ ylab('Proportion positive')+ theme(axis.text.x=element_text(angle=60, hjust=1))+
geom_line(aes(x=AgeMid, y=P_inf), col='tomato')+ scale_x_continuous(breaks=new$AgeMid, labels=ages)+
geom_ribbon(aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='tomato', alpha=0.5)+ xlab('Age')+
geom_point(data=new, aes(AgeMid-0.5, serop))+
geom_linerange(data=new, aes(x=AgeMid-0.5, ymin=lower_ci, ymax=upper_ci))+
geom_line(data=new, aes(x=AgeMid, y=P_inf), col='tomato')+ scale_x_continuous(breaks=new$AgeMid,
labels=ages)+
geom_ribbon(data=new, aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='tomato', alpha=0.5)+ xlab('Age')
plot_grid(tdis2, foi2, labels=c('(A)', '(B)'))
foi2
foi2 <- ggplot(new2)+ geom_point(aes(AgeMid+0.5, serop), col='tomato3')+
geom_linerange(aes(x=AgeMid+0.5, ymin=lower_ci, ymax=upper_ci), col='tomato3')+
theme_minimal()+ ylab('Proportion positive')+ theme(axis.text.x=element_text(angle=60, hjust=1))+
geom_line(aes(x=AgeMid, y=P_inf), col='tomato')+ scale_x_continuous(breaks=new$AgeMid, labels=ages)+
geom_ribbon(aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='tomato', alpha=0.5)+ xlab('Age')+
geom_point(data=new, aes(AgeMid-0.5, serop))+
geom_linerange(data=new, aes(x=AgeMid-0.5, ymin=lower_ci, ymax=upper_ci))+
geom_line(data=new, aes(x=AgeMid, y=P_inf), col='skyblue')+ scale_x_continuous(breaks=new$AgeMid,
labels=ages)+
geom_ribbon(data=new, aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='skyblue', alpha=0.5)+ xlab('Age')
foi2
foi2 <- ggplot(new2)+ geom_point(aes(AgeMid+0.5, serop), col='tomato3')+
geom_linerange(aes(x=AgeMid+0.5, ymin=lower_ci, ymax=upper_ci), col='tomato3')+
theme_minimal()+ ylab('Proportion positive')+ theme(axis.text.x=element_text(angle=60, hjust=1))+
geom_line(aes(x=AgeMid, y=P_inf), col='tomato')+ scale_x_continuous(breaks=new$AgeMid, labels=ages)+
geom_ribbon(aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='tomato', alpha=0.5)+ xlab('Age')+
geom_point(data=new, aes(AgeMid-0.5, serop))+
geom_linerange(data=new, aes(x=AgeMid-0.5, ymin=lower_ci, ymax=upper_ci))+
geom_line(data=new, aes(x=AgeMid, y=P_inf), col='blue')+ scale_x_continuous(breaks=new$AgeMid,
labels=ages)+
geom_ribbon(data=new, aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='skyblue', alpha=0.5)+ xlab('Age')
foi2
foi2 <- ggplot(new2)+ geom_point(aes(AgeMid+0.5, serop), col='tomato3')+
geom_linerange(aes(x=AgeMid+0.5, ymin=lower_ci, ymax=upper_ci), col='tomato3')+
theme_minimal()+ ylab('Proportion positive')+ theme(axis.text.x=element_text(angle=60, hjust=1))+
geom_line(aes(x=AgeMid, y=P_inf), col='tomato')+ scale_x_continuous(breaks=new$AgeMid, labels=ages)+
geom_ribbon(aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='tomato', alpha=0.5)+ xlab('Age')+
geom_point(data=new, aes(AgeMid-0.5, serop), col='skyblue')+
geom_linerange(data=new, aes(x=AgeMid-0.5, ymin=lower_ci, ymax=upper_ci), col='skyblue')+
geom_line(data=new, aes(x=AgeMid, y=P_inf), col='blue')+ scale_x_continuous(breaks=new$AgeMid,
labels=ages)+
geom_ribbon(data=new, aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='skyblue', alpha=0.5)+ xlab('Age')
foi2
foi2 <- ggplot(new2)+
geom_line(data=new, aes(x=AgeMid, y=P_inf), col='blue')+ scale_x_continuous(breaks=new$AgeMid,
labels=ages)+
geom_ribbon(data=new, aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='skyblue', alpha=0.5)+ xlab('Age')+
geom_ribbon(aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='tomato', alpha=0.5)+ xlab('Age')+
geom_point(aes(AgeMid+0.5, serop), col='tomato3')+
geom_linerange(aes(x=AgeMid+0.5, ymin=lower_ci, ymax=upper_ci), col='tomato3')+
theme_minimal()+ ylab('Proportion positive')+ theme(axis.text.x=element_text(angle=60, hjust=1))+
geom_line(aes(x=AgeMid, y=P_inf), col='tomato')+ scale_x_continuous(breaks=new$AgeMid, labels=ages)+
geom_point(data=new, aes(AgeMid-0.5, serop), col='skyblue')+
geom_linerange(data=new, aes(x=AgeMid-0.5, ymin=lower_ci, ymax=upper_ci), col='skyblue')
foi2
foi2 <- ggplot(new2)+
geom_line(data=new, aes(x=AgeMid, y=P_inf), col='blue')+ scale_x_continuous(breaks=new$AgeMid,
labels=ages)+
geom_ribbon(data=new, aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='skyblue', alpha=0.5)+ xlab('Age')+
geom_ribbon(aes(x=AgeMid, ymin=P_infL, ymax=P_infU), fill='tomato', alpha=0.5)+ xlab('Age')+
geom_point(aes(AgeMid+0.5, serop), col='tomato3')+
geom_linerange(aes(x=AgeMid+0.5, ymin=lower_ci, ymax=upper_ci), col='tomato3')+
theme_minimal()+ ylab('Proportion positive')+ theme(axis.text.x=element_text(angle=60, hjust=1))+
geom_line(aes(x=AgeMid, y=P_inf), col='tomato')+ scale_x_continuous(breaks=new$AgeMid, labels=ages)+
geom_point(data=new, aes(AgeMid-0.5, serop), col='blue')+
geom_linerange(data=new, aes(x=AgeMid-0.5, ymin=lower_ci, ymax=upper_ci), col='blue')
foi2
plot_grid(tdis2, foi2, labels=c('(A)', '(B)'))
rm(list=ls())
library(rstan)
# source functions
setwd('C:/Users/Megan/Documents/GitHub/International-COVID-IFR')
source('./code/FunctionsForIFR.R')
# death data (adjusted for NH)
#df_adj <- read.csv('./data/deaths_age_adjusted.csv')
#countries_adj <- sort(unique(df_adj$country))
#countries_adj <- as.character(countries_adj[!countries_adj %in% c('Switzerland')])
#countries_adj <- as.character(countries_adj[!countries_adj %in% c('Canada','Switzerland','Hungary','Belgium','United States of America')])
# death data (adjusted)
df <- read.csv('./data/deaths_age_adjusted2.csv')
countries <- sort(unique(df$country))
countries
countries <- countries[!countries %in% c('United States of America','Belgium','Canada','New York City',
'New York State')]
df <- df[df$country %in% countries,]
df <- agg_deathsAp(df, countries, 80)
# population data (not adjusted)
poplist <- list()
countries <- sort(countries)
for(k in unique(countries)){
poplist[[k]] <- read.csv(paste('./data/population/general-population/', k,'-2019.csv', sep=''))
}
# Diamond Princess & Charles de Gaulle data
dpraw <- read.csv('./data/DiamondPrincess.csv')
dpd <- adjust_DPdata(dpraw)
cdg <- read.csv('./data/CharlesDeGaulle.csv')
# align death and pop data
#dff <- df[df$age_max<65,]
#dff <- df_adj
dff <- df
dff$age_max[dff$age_max==17] <- 19
dff$age_min[dff$age_min==18] <- 20
# data inputs for model
countries <- sort(as.character(countries))
Inputs <- get_inputs(countries, poplist, poplist, dff, cdg, dpd)
Inputs$relProbInfection <- rep(1,17) # rel prob infection
Inputs$countries <- countries
# run model
setwd('C:/Users/Megan/Documents/GitHub/International-COVID-IFR/code')
fit <- runStan(model='IFRinternationalLinear.stan', Inputs, N_iter=500, N_chains=1, max_td=15, ad=0.8)
5000000*0.02
1e3
100000*0.98
fit <- runStan(model='IFRinternationalLinear.stan', Inputs, N_iter=1000, N_chains=1, max_td=15, ad=0.8)
fit <- runStan(model='IFRinternationalLinear.stan', Inputs, N_iter=500, N_chains=1, max_td=15, ad=0.8)
# check chains
chains <- rstan::extract(fit)
traceplot(fit, pars=names(fit)[1:10])
data <- dff
inputs <- Inputs
amaxLim <- 45
# age mid & age groups for plots
data$age_mid <- data$age_min+((data$age_max-data$age_min)+1)/2
data$ageG <- paste(data$age_min, data$age_max, sep='-')
data$ageG[data$age_max==110] <- paste(data$age_min[data$age_max==110], '+', sep='')
c <- 1
dfc <- data[data$country==countries[c], ]
nages <- inputs$NAges[c]
View(dfc)
# extract samples
fit_b <- t(apply(chains$natDeath_b[,,c], 2, quantile, probs=c(0.5,0.025,0.975)))
# aggregate to data age groups
fit_ba <- matrix(NA, nrow=nages, ncol=3)
for(a in 1:nages){
for(ci in 1:3){
fit_ba[a,ci] <- sum(fit_b[inputs$ageG_min[a,c]:inputs$ageG_max[a,c],ci])
}
}
fit <- data.frame(n=inputs$deaths_b[1:nages,c], sex=rep('B',nages), amin=dfc$age_min, amax=dfc$age_max,
age=dfc$ageG, fit=fit_ba[,1], ciL=fit_ba[,2], ciU=fit_ba[,3])
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(fill='seagreen2')+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit))+geom_linerange(aes(age, ymin=ciL, ymax=ciU))+
labs(subtitle=paste(dfc$country[1]))
View(fit)
fit$n <- fit$fit
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(fill='seagreen2')+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit))+geom_linerange(aes(age, ymin=ciL, ymax=ciU))+
labs(subtitle=paste(dfc$country[1]))
fit$alpha <- 0
fit$alpha[fit$amax<amaxLim] <- 1
amaxLim <- 70
fit$alpha[fit$amax<amaxLim] <- 1
View(dfc)
# extract samples
fit_m <- t(apply(chains$natDeath_m[,,c], 2, quantile, probs=c(0.5,0.025,0.975)))
fit_f <- t(apply(chains$natDeath_f[,,c], 2, quantile, probs=c(0.5,0.025,0.975)))
# aggregate to data age groups
fit_ma <- matrix(NA, nrow=nages, ncol=3)
fit_fa <- matrix(NA, nrow=nages, ncol=3)
for(a in 1:nages){
for(ci in 1:3){
fit_ma[a,ci] <- sum(fit_m[inputs$ageG_min[a,c]:inputs$ageG_max[a,c], ci])
fit_fa[a,ci] <- sum(fit_f[inputs$ageG_min[a,c]:inputs$ageG_max[a,c], ci])
}
}
fit <- data.frame(n=c(inputs$deaths_m[1:nages,c],inputs$deaths_f[1:nages,c]),
sex=c(rep('M',nages),rep('F',nages)), amin=sort(unique(dfc$age_min)),
amax=sort(unique(dfc$age_max)), age=NA,
fit=c(fit_ma[,1], fit_fa[,1]), ciL=c(fit_ma[,2], fit_fa[,2]),
ciU=c(fit_ma[,3], fit_fa[,3]))
View(fit)
for(a in 1:nrow(fit)) fit$age[a] <- dfc$ageG[dfc$age_min==fit$amin[a]][1]
fit$sex <- factor(fit$sex, levels=c('F','M'))
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))
fit$fit <- fit$n
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))
fit$alpha <- 0
fit$alpha[fit$amax<amaxLim] <- 1
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=alpha), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))
fit <- data.frame(n=c(inputs$deaths_m[1:nages,c],inputs$deaths_f[1:nages,c]),
sex=c(rep('M',nages),rep('F',nages)), amin=sort(unique(dfc$age_min)),
amax=sort(unique(dfc$age_max)), age=NA, alpha=1,
fit=c(fit_ma[,1], fit_fa[,1]), ciL=c(fit_ma[,2], fit_fa[,2]),
ciU=c(fit_ma[,3], fit_fa[,3]))
for(a in 1:nrow(fit)) fit$age[a] <- dfc$ageG[dfc$age_min==fit$amin[a]][1]
fit$sex <- factor(fit$sex, levels=c('F','M'))
fit$alpha[fit$amax<amaxLim] <- 0.75
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))
fit$fit <- fit$n
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))
fit <- data.frame(n=c(inputs$deaths_m[1:nages,c],inputs$deaths_f[1:nages,c]),
sex=c(rep('M',nages),rep('F',nages)), amin=sort(unique(dfc$age_min)),
amax=sort(unique(dfc$age_max)), age=NA, alpha=0.25,
fit=c(fit_ma[,1], fit_fa[,1]), ciL=c(fit_ma[,2], fit_fa[,2]),
ciU=c(fit_ma[,3], fit_fa[,3]))
for(a in 1:nrow(fit)) fit$age[a] <- dfc$ageG[dfc$age_min==fit$amin[a]][1]
fit$sex <- factor(fit$sex, levels=c('F','M'))
fit$alpha[fit$amax<amaxLim] <- 1
fit$fit <- fit$n
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))
fit <- data.frame(n=c(inputs$deaths_m[1:nages,c],inputs$deaths_f[1:nages,c]),
sex=c(rep('M',nages),rep('F',nages)), amin=sort(unique(dfc$age_min)),
amax=sort(unique(dfc$age_max)), age=NA, alpha=0.8,
fit=c(fit_ma[,1], fit_fa[,1]), ciL=c(fit_ma[,2], fit_fa[,2]),
ciU=c(fit_ma[,3], fit_fa[,3]))
for(a in 1:nrow(fit)) fit$age[a] <- dfc$ageG[dfc$age_min==fit$amin[a]][1]
fit$sex <- factor(fit$sex, levels=c('F','M'))
fit$alpha[fit$amax<amaxLim] <- 1
fit$fit <- fit$n
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(1,0.3))
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.8,1))
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.6,1))
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1))
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), legend=F)
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)
fit <- data.frame(n=c(inputs$deaths_m[1:nages,c],inputs$deaths_f[1:nages,c]),
sex=c(rep('M',nages),rep('F',nages)), amin=sort(unique(dfc$age_min)),
amax=sort(unique(dfc$age_max)), age=NA, alpha='0',
fit=c(fit_ma[,1], fit_fa[,1]), ciL=c(fit_ma[,2], fit_fa[,2]),
ciU=c(fit_ma[,3], fit_fa[,3]))
for(a in 1:nrow(fit)) fit$age[a] <- dfc$ageG[dfc$age_min==fit$amin[a]][1]
fit$sex <- factor(fit$sex, levels=c('F','M'))
fit$alpha[fit$amax<amaxLim] <- '1'
fit <- data.frame(n=c(inputs$deaths_m[1:nages,c],inputs$deaths_f[1:nages,c]),
sex=c(rep('M',nages),rep('F',nages)), amin=sort(unique(dfc$age_min)),
amax=sort(unique(dfc$age_max)), age=NA, alpha=0,
fit=c(fit_ma[,1], fit_fa[,1]), ciL=c(fit_ma[,2], fit_fa[,2]),
ciU=c(fit_ma[,3], fit_fa[,3]))
for(a in 1:nrow(fit)) fit$age[a] <- dfc$ageG[dfc$age_min==fit$amin[a]][1]
fit$sex <- factor(fit$sex, levels=c('F','M'))
fit$alpha[fit$amax<amaxLim] <- 1
fit$fit <- fit$n
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, group=sex), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)
ggplot(fit, aes(reorder(age,amin), n))+ xlab('')+ ylab('')+ theme_minimal()+
geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
labs(subtitle=paste(inputs$county[c]))+ labs(fill='')+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
geom_point(aes(age, fit, group=sex, shape=alpha), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)
ggplot(fit, aes(reorder(age,amin), n))+ xlab('')+ ylab('')+ theme_minimal()+
geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
labs(subtitle=paste(inputs$county[c]))+ labs(fill='')+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
geom_point(aes(age, fit, group=sex, shape=as.factor(alpha)), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)
ggplot(fit, aes(reorder(age,amin), n))+ xlab('')+ ylab('')+ theme_minimal()+
geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
labs(subtitle=paste(inputs$county[c]))+ labs(fill='')+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
geom_point(aes(age, fit, group=sex, shape=as.factor(alpha)), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)+
scale_shape_manual(values=c(16,8))
ggplot(fit, aes(reorder(age,amin), n))+ xlab('')+ ylab('')+ theme_minimal()+
geom_col(aes(fill=sex, alpha=factor(alpha)), position=position_dodge())+
labs(subtitle=paste(inputs$county[c]))+ labs(fill='')+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
geom_point(aes(age, fit, group=sex, shape=as.factor(alpha)), position=position_dodge(width=0.9))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU, group=sex), position=position_dodge(width=0.9))+
scale_fill_manual(values=c('indianred1','royalblue1'), labels=c('female','male'))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)+
scale_shape_manual(values=c(8,16), guide=F)
countries
c <- 3
dfc <- data[data$country==countries[c], ]
nages <- inputs$NAges[c]
# extract samples
fit_b <- t(apply(chains$natDeath_b[,,c], 2, quantile, probs=c(0.5,0.025,0.975)))
# aggregate to data age groups
fit_ba <- matrix(NA, nrow=nages, ncol=3)
for(a in 1:nages){
for(ci in 1:3){
fit_ba[a,ci] <- sum(fit_b[inputs$ageG_min[a,c]:inputs$ageG_max[a,c],ci])
}
}
fit <- data.frame(n=inputs$deaths_b[1:nages,c], sex=rep('B',nages), amin=dfc$age_min, amax=dfc$age_max,
age=dfc$ageG, fit=fit_ba[,1], ciL=fit_ba[,2], ciU=fit_ba[,3], alpha=0)
fit$alpha[fit$amax<amaxLim] <- 1
plotD[[c]] <- ggplot(fit, aes(reorder(age,amin), n))+ geom_col(fill='seagreen2', aes(alpha=alpha))+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, shape=as.factor(alpha)))+
geom_linerange(aes(age, ymin=ciL, ymax=ciU))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)+
scale_shape_manual(values=c(8,16), guide=F)
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(fill='seagreen2', aes(alpha=alpha))+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, shape=as.factor(alpha)))+
geom_linerange(aes(age, ymin=ciL, ymax=ciU))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)+
scale_shape_manual(values=c(8,16), guide=F)
fit$fit <- fit$n
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(fill='seagreen2', aes(alpha=alpha))+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, shape=as.factor(alpha)))+
geom_linerange(aes(age, ymin=ciL, ymax=ciU))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)+
scale_shape_manual(values=c(8,16), guide=F)
ggplot(fit, aes(reorder(age,amin), n))+ #geom_col(fill='seagreen2', aes(alpha=alpha))+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, shape=as.factor(alpha)))+
geom_linerange(aes(age, ymin=ciL, ymax=ciU))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)+
scale_shape_manual(values=c(8,16), guide=F)
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(fill='seagreen2', aes(alpha=factor(alpha)))+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, shape=as.factor(alpha)))+
geom_linerange(aes(age, ymin=ciL, ymax=ciU))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)+
scale_shape_manual(values=c(8,16), guide=F)
ggplot(fit, aes(reorder(age,amin), n))+ geom_col(fill='seagreen2', aes(alpha=factor(alpha)))+
xlab('')+ ylab('')+ theme_minimal()+ labs(subtitle=paste(inputs$county[c]))+
theme(axis.text.x=element_text(angle=60, hjust=1),legend.position=c(0.15,0.9))+
labs(fill='')+ geom_point(aes(age, fit, shape=as.factor(alpha)))+
#geom_linerange(aes(age, ymin=ciL, ymax=ciU))+
labs(subtitle=paste(dfc$country[1]))+ scale_alpha_manual(values=c(0.5,1), guide=F)+
scale_shape_manual(values=c(8,16), guide=F)
source('~/GitHub/International-COVID-IFR/code/FunctionsForIFR.R')
